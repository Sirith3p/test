<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Thyroid Pathology — Decision Tree with Negative Marking</title>
<style>
  :root{--bg:#0f1724;--card:#0b1220;--accent:#38bdf8;--muted:#94a3b8}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#071124 0%, #081627 60%);color:#e6eef8;display:flex;align-items:center;justify-content:center;padding:20px}
  .app{width:100%;max-width:980px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#7dd3fc);display:flex;align-items:center;justify-content:center;color:#04263a;font-weight:800}
  h1{margin:0;font-size:20px}
  .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 30px rgba(2,6,23,.6)}
  .layout{display:grid;grid-template-columns:1fr 320px;gap:16px}
  .node{margin-bottom:12px}
  .question{font-weight:700;margin-bottom:8px}
  .opts{display:flex;flex-direction:column;gap:8px}
  .opt{background:#071827;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.03);cursor:pointer;text-align:left}
  .opt.small{font-size:13px}
  aside .panel{margin-bottom:12px}
  .path{font-family:monospace;background:#061421;padding:8px;border-radius:8px;font-size:13px}
  .meta{font-size:13px;color:var(--muted)}
  .controls{display:flex;gap:8px;margin-top:10px}
  button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#04263a;font-weight:700;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.04);color:var(--muted)}
  .trace{max-height:240px;overflow:auto;padding:8px}
  .score{font-size:18px;font-weight:700;margin-bottom:8px}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">T</div>
    <div>
      <h1>Thyroid Pathology — Decision Tree (Negative Marking)</h1>
      <div class="meta">เลือกการตัดสินใจแต่ละขั้นตอน คะแนนอาจลดลงถ้าตอบผิด/ไม่เหมาะสม</div>
    </div>
  </header>

  <div class="card layout">
    <main>
      <div id="nodeArea"></div>
      <div class="score">คะแนนรวม: <span id="scoreDisplay">0</span></div>
      <div class="controls">
        <button id="backBtn" class="btn-ghost">ย้อนกลับ</button>
        <button id="resetBtn">เริ่มใหม่</button>
      </div>
    </main>

    <aside>
      <div class="card panel">
        <div style="font-weight:700">Current case</div>
        <div id="caseTitle" style="margin-top:6px">Loading...</div>
        <div class="meta" id="caseMeta"></div>
      </div>

      <div class="card panel">
        <div style="font-weight:700">Decision path</div>
        <div class="trace" id="trace"></div>
      </div>
    </aside>
  </div>
</div>

<script>
// Decision tree with negative marking
const cases = [
  {
    id:0,
    title:'Case 1: 45-year-old woman with solitary thyroid nodule',
    meta:'Clinical: solitary, non-tender; Ultrasound: 2.2 cm hypoechoic nodule',
    tree: {
      id:'start',
      text:'คุณจะทำอะไรเป็นขั้นแรก?',
      choices:[
        {text:'FNA', next:'fna', points:10},
        {text:'Follow-up ultrasound', next:'obs', points:-5},
        {text:'TFTs', next:'tft', points:-2}
      ]
    },
    nodes: {
      fna:{
        id:'fna',
        text:'FNA ผลเป็น Bethesda V. ขั้นตอนต่อไป?',
        choices:[
          {text:'Lobectomy', next:'surgery', points:10},
          {text:'Molecular testing', next:'molecular', points:5},
          {text:'Repeat FNA', next:'repeat_fna', points:-5}
        ]
      },
      obs:{id:'obs', text:'Follow-up พบ nodal enlargement. ทำต่อ?', choices:[{text:'FNA', next:'fna', points:5},{text:'Surgery', next:'surgery', points:10}]},
      tft:{id:'tft', text:'TFTs ปกติ. ทำอะไรต่อ?', choices:[{text:'FNA', next:'fna', points:10},{text:'ติดตาม 6 เดือน', next:'obs', points:-2}]},
      repeat_fna:{id:'repeat_fna', text:'Repeat FNA กลายเป็น Bethesda III', choices:[{text:'Molecular testing', next:'molecular', points:5},{text:'Lobectomy', next:'surgery', points:10}]},
      molecular:{id:'molecular', text:'BRAF V600E พบ — แนะนำการรักษา?', choices:[{text:'Total thyroidectomy + RAI', next:'final', points:10},{text:'Follow-up', next:'final', points:-5}]},
      surgery:{id:'surgery', text:'Histology: Papillary carcinoma — การวางแผนต่อ?', choices:[{text:'Total thyroidectomy + RAI', next:'final', points:10},{text:'Lobectomy + follow-up', next:'final', points:5}]},
      final:{id:'final', text:'เส้นทางสิ้นสุด — สรุปผลการรักษา', choices:[]}
    }
  }
];

let currentCase = cases[0];
let currentNode = null;
let path = [];
let score = 0;

const nodeArea = document.getElementById('nodeArea');
const caseTitle = document.getElementById('caseTitle');
const caseMeta = document.getElementById('caseMeta');
const traceEl = document.getElementById('trace');
const scoreDisplay = document.getElementById('scoreDisplay');

function loadCase(idx=0){
  currentCase = cases[idx];
  currentNode = currentCase.tree;
  path = [{node:currentNode.id, action:null, points:0}];
  score = 0;
  render();
}

function render(){
  caseTitle.textContent = currentCase.title;
  caseMeta.textContent = currentCase.meta;
  nodeArea.innerHTML = '';

  const nodeCard = document.createElement('div');
  nodeCard.className='card node';
  const q = document.createElement('div'); q.className='question'; q.textContent=currentNode.text;
  nodeCard.appendChild(q);

  const opts = document.createElement('div'); opts.className='opts';
  const choices = (currentCase.nodes && currentCase.nodes[currentNode.id]) ? currentCase.nodes[currentNode.id].choices : currentNode.choices;

  if(choices && choices.length>0){
    choices.forEach(c=>{
      const b = document.createElement('div'); b.className='opt small'; b.textContent=c.text;
      b.addEventListener('click',()=>choose(c));
      opts.appendChild(b);
    });
  }else{
    const end = document.createElement('div'); end.className='opt'; end.textContent='(จบบท)'; opts.appendChild(end);
  }
  nodeCard.appendChild(opts);
  nodeArea.appendChild(nodeCard);

  renderTrace();
  scoreDisplay.textContent = score;
}

function choose(choice){
  score += choice.points;
  path.push({node:choice.next, action:choice.text, points:choice.points});
  const nodes = currentCase.nodes;
  if(nodes && nodes[choice.next]){
    currentNode = nodes[choice.next];
  }else{
    currentNode = {id:choice.next, text:'(Node not found)', choices:[]};
  }
  render();
}

function renderTrace(){
  traceEl.innerHTML='';
